# Go Template - BE API

Template to create backend API repositories in Golang.

Go through the following sections to understand what all features are included in the template out of the box, and how do they function. Steps to integrate a CI setup (with the help of infra) is also included.

## Initialize repo locally

1. Run the following command to initialize the repository after cloning. It will install some global dependencies that are needed to perform linting (locally), spec file generation, Git hooks, etc.

   ```shell
   make init
   ```

### Onetime steps to follow for setting up a new Golang repository

1. Globally search "go-be-template" in the repository and replace it with your repository name.
1. Update the `README.md` file to remove the repository-setup sections. Recommendation: keep the repo initialization, go-mock and auto-Swagger specs generation sections for context.

## Setup CI

The repository configs needs to be stored in [sc-infra-ci-configs](https://github.com/smallcase/sc-infra-ci-configs) that is maintained by the infra. Raise a PR in the infra repo with your repo configs.

There are two jobs that needs to be configured in the CI-setup:

1. Run the linter, all the test cases, and check for the test coverage threshold when a PR is raised.
1. Run the linter, all the test cases, and check for the test coverage threshold when a commit is pushed to one of the "important" branches.

Copy-paste the following template in the `smallci/jobs/<team-name>/<repo-name>` file in the infra repository. Make sure to replace `{{repo_name}}` with your repository name in the template.

```yaml
apiVersion: ci.smallcase.com/v1beta1
kind: Job
metadata:
  name: {{repo_name}}-ci
  namespace: smallci-system
spec:
  subscribers:
    {{repo_name}}:
      - eventType: pull_request
        eventAction:
          - opened
          - reopened
          - synchronize
        eventBranch:
          - .*
      - eventType: push
        eventBranch:
          - main
          - development
          - dev/*
          - release/*
  tasks:
    test:
      cloneRepo: true
      image: golang:1.18-stretch
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting go test\n"
          make test
    golangci-lint:
      cloneRepo: true
      image: golangci/golangci-lint:v1.51.1
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting golangci-lint\n"
          make lint
    test-coverage:
      cloneRepo: true
      image: golang:1.18-stretch
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting test-coverage threshold check\n"
          make testcoverage
```

## Steps to create a mock module

The repository uses [golang/mock](https://github.com/golang/mock) to auto-generate mocks of interfaces. This will encourage developers to first define an `interface` in their module before starting with the implementation, and to use this `interface` everywhere else in the code as well.

The `mockgen` CLI should automatically be installed on your machine if you ran `make init` at the time of repository setup. You just need to point to the source Go file with the `interface` and the destination Go file where you would want your mock implementation of the `interface`. That's it!

E.g. the mock implementation of all the store interfaces was generated by the following command:

```shell
mockgen -source=pkg/store/store.go -destination=pkg/store/mock/store.go
```

You can now import the mock implementation of the store by importing the `mock_store` intead of `store` module.

It is recommended to generate a `mock` directory at the same place where the interface resides.

## Auto-generated Swagger files

The `docs/__index.html` and `docs/__swagger.yaml` are auto-generated files. Therefore, do not make any changes in these files because the changes will be overridden when you are commiting the changes. A `make` script is attached to the pre-commit Git hook to automatically generate these fiels. Note, that you will not have to explicitly stage these files to Git; the Git pre-commit hook takes care of everything by itself.

Basic Swagger configurations are stored in the `docs/swagger.base.yaml` file; you can edit this file as per your liking. This file is imported to generate the `docs/__swagger.yaml` file, which in turn is used to generate the `docs/__index.html` file.

A specific HTTP router is created to serve the `docs/__index.html` file on the `/docs` endpoint. Note, that the `/ocs` endpoint will be by-default disabled on production.

You can document your models and APIs using [godocs](https://go.dev/blog/godoc). Go through [this documentation](https://goswagger.io/use/spec.html) to understand how does go-swagger uses godoc annotations to generate the Swagger specs file.

A sample documentation for a model and an API is already included:

1. Model: [Binotto model](/pkg/binotto/binotto.go)
1. API: [Binotto Sample GET endpoint](/internal/api/binotto/binotto.go)

The model is used as a response object in the API as an example on how to inter-link different pieces in the final Swagger specs file.
