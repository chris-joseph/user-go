# Go Template - BE API

Template to create backend API repositories in Golang

## Setup the development environment

1. Run the following command to initialize the local development setup (e.g. [Husky](https://github.com/typicode/husky), [golangci-lint](https://github.com/golangci/golangci-lint)):

   ```shell
   make init
   ```

### Reading material

1. [Go standards project layout](https://github.com/golang-standards/project-layout)
1. [Reference repo #1](https://github.com/smallcase/sc-integrations-orders-api)
1. [Reference repo #2](https://github.com/smallcase/use-be-integrations-sbm-funds)

### Steps to follow for setting up a new Golang repository

1. Globally search "go-be-template" in the repository and replace it with your repository name.
1. Update this `README.md` file to remove `Reading material` and `Golang repo setup` instructions.

## Setup CI

The repository configs needs to be stored in [sc-infra-ci-configs](https://github.com/smallcase/sc-infra-ci-configs) that is maintained by the infra. Raise a PR in the infra repo with your repo configs.

There are two jobs that needs to be configured in the CI-setup:

1. Run the linter, all the test cases, and check for the test coverage threshold when a PR is raised.
1. Run the linter, all the test cases, and check for the test coverage threshold when a commit is pushed to one of the "important" branches.

Copy-paste the following template in the `smallci/jobs/<team-name>/<repo-name>` file in the infra repository. Make sure to replace `{{repo_name}}` with your repository name in the template.

```yaml
apiVersion: ci.smallcase.com/v1beta1
kind: Job
metadata:
  name: {{repo_name}}-ci
  namespace: smallci-system
spec:
  subscribers:
    {{repo_name}}:
      - eventType: pull_request
        eventAction:
          - opened
          - reopened
          - synchronize
        eventBranch:
          - .*
      - eventType: push
        eventBranch:
          - main
          - development
          - dev/*
          - release/*
  tasks:
    test:
      cloneRepo: true
      image: golang:1.18-stretch
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting go test\n"
          make test
    golangci-lint:
      cloneRepo: true
      image: golangci/golangci-lint:v1.51.1
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting golangci-lint\n"
          make lint
    test-coverage:
      cloneRepo: true
      image: golang:1.18-stretch
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace
          printf "starting test-coverage threshold check\n"
          make testcoverage
```

## Steps to create a mock module

The repository uses `golang/mock` to auto-generate mocks of interfaces. This will encourage developers to first define an `interface` in their module before starting with the implementation, and to use this `interface` everywhere in the code as well.

The `mockgen` CLI should automatically be installed on your machine if you ran `make init` at the time of repository setup. You just need to point to the source Go file with the `interface` and the destination Go file where you would want your mock implementation of the `interface`. That's it!

E.g. the mock implementation of all the store interfaces was generated by the following command:

```shell
mockgen -source=pkg/store/store.go -destination=pkg/store/mock/store.go
```

You can now import the mock implementation of the store by importing the `mock_store` intead of `store` module.

It is recommended to generate a `mock` directory at the same place where the interface resides.
